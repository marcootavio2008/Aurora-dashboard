{% extends "base.html" %}
{% block page_title %} Configura칞칫es {% endblock %}

{% block content %}

<h1 class="page-title"> 游녻 PERFIL </h1>

<div>
<div class="card">
  <div class="row">
    <div class="field">
      <label>Nome exibido</label>
      <input type="text" id="nome" placeholder="Ex: Jo칚o">
    </div>

  <div class="row">
    <div class="field">
      <label>Senha</label>
      <input type="text" id="senha" placeholder="Ex: 1234">
    </div>

  <div class="row">
    <div class="field">
      <label>Permiss칚o</label>
      <input type="text" id="role" placeholder="admin ou visitante">
    </div>

  <div class="field">
  <label>Casa do usu치rio</label>
  <select id="userHouseSelect"></select>
  </div>


    <h1>游 CASAS</h1>

<div class="card">
  <label>Casa ativa</label>
  <select id="houseSelect"></select>

  <button class="botoes-config" onclick="selecionarCasa()">Selecionar</button>

  <hr>

  <label>Nova casa</label>
  <input type="text" id="newHouseName" placeholder="Ex: Casa da Praia">
  <button class="botoes-config" onclick="criarCasa()">Adicionar Casa</button>
</div>


<div class="actions">
  <button class="btn-secondary">Cancelar</button>
  <button class="btn-primary" onclick="criarUsuario()">
    Salvar Configura칞칫es
  </button>
</div>

<h2>-------------------------------</h2> 


<h1> 游논 USU츼RIOS </h1>
<table id="usersTable">
  <thead>
    <tr>
      <th>Usu치rio</th>
      <th>Perfil</th>
      <th>A칞칚o</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>
</div>

<script>
/* ==========================
   CASAS
========================== */
async function carregarCasas() {
  const res = await fetch("/api/houses");
  const houses = await res.json();

  // Select da casa ativa
  const select = document.getElementById("houseSelect");
  select.innerHTML = "";
  houses.forEach(h => {
    const opt = document.createElement("option");
    opt.value = h.id;
    opt.textContent = h.name;
    select.appendChild(opt);
  });

  // Select da casa padr칚o do usu치rio
  const userHouseSelect = document.getElementById("userHouseSelect");
  if (userHouseSelect) {
    userHouseSelect.innerHTML = "";
    houses.forEach(h => {
      const opt = document.createElement("option");
      opt.value = h.id;
      opt.textContent = h.name;
      userHouseSelect.appendChild(opt);
    });
  }
}

async function selecionarCasa() {
  const house_id = document.getElementById("houseSelect").value;

  const res = await fetch("/api/houses/select", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({ house_id })
  });

  if (res.ok) {
    alert("Casa selecionada!");
  } else {
    const data = await res.json();
    alert("Erro ao selecionar casa: " + (data.error || "Erro desconhecido"));
  }
}

async function criarCasa() {
  const name = document.getElementById("newHouseName").value;

  if (!name) {
    alert("Digite o nome da nova casa");
    return;
  }

  const res = await fetch("/api/houses", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({ name })
  });

  if (res.ok) {
    document.getElementById("newHouseName").value = "";
    await carregarCasas();
    alert("Casa criada com sucesso!");
  } else {
    const data = await res.json();
    alert("Erro ao criar casa: " + (data.error || "Erro desconhecido"));
  }
}

/* ==========================
   USU츼RIOS
========================== */
async function carregarUsuarios() {
  const res = await fetch("/api/users");
  const data = await res.json();

  if (!res.ok) {
    alert("N칚o foi poss칤vel carregar usu치rios: " + (data.error || "Erro desconhecido"));
    return;
  }

  const tbody = document.querySelector("#usersTable tbody");
  tbody.innerHTML = "";

  data.forEach(u => {
    const tr = document.createElement("tr");

    tr.innerHTML = `
      <td>${u.username}</td>
      <td>${u.role}</td>
      <td>
        <button class="botoes-config" onclick="apagarUsuario(${u.id})">游딈 Apagar</button>
      </td>
    `;

    tbody.appendChild(tr);
  });
}

async function apagarUsuario(id) {
  if (!confirm("Tem certeza que deseja apagar este usu치rio?")) return;

  const res = await fetch(`/api/users/${id}`, {
    method: "DELETE"
  });

  if (res.ok) {
    carregarUsuarios();
  } else {
    const data = await res.json();
    alert("Erro ao apagar usu치rio: " + (data.error || "Erro desconhecido"));
  }
}

async function criarUsuario() {
  const username = document.getElementById("nome").value;
  const password = document.getElementById("senha").value;
  const role = document.getElementById("role").value;
  const house_id = document.getElementById("userHouseSelect").value; // nova linha

  if (!username || !password) {
    alert("Preencha usu치rio e senha!");
    return;
  }

  const res = await fetch("/api/users", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({username, password, role, house_id}) // house_id inclu칤do
  });

  const data = await res.json();

  if (res.ok) {
    alert("Usu치rio criado com sucesso!");
    document.getElementById("nome").value = "";
    document.getElementById("senha").value = "";
    document.getElementById("role").value = "";
    carregarUsuarios();
  } else {
    alert("Erro ao criar usu치rio: " + (data.error || "Erro desconhecido"));
  }
}

/* ==========================
   INIT
========================== */
document.addEventListener("DOMContentLoaded", () => {
  carregarCasas();
  carregarUsuarios();
});
</script>
{% endblock %}
