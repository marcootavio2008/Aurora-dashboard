{% extends "base.html" %}
{% block page_title %} Configura√ß√µes {% endblock %}

{% block content %}

<h1 class="page-title"> üë§ PERFIL </h1>

<div class="card">
  <div class="row">
    <div class="field">
      <label>Nome exibido</label>
      <input type="text" id="nome" placeholder="Ex: Jo√£o">
    </div>

  <div class="row">
    <div class="field">
      <label>Senha</label>
      <input type="text" id="senha" placeholder="Ex: 1234">
    </div>

  <div class="row">
    <div class="field">
      <label>Permiss√£o</label>
      <input type="text" id="role" placeholder="admin ou visitante">
    </div>

    <h1>üè† CASAS</h1>

<div class="card">
  <label>Casa ativa</label>
  <select id="houseSelect"></select>

  <button onclick="selecionarCasa()">Selecionar</button>

  <hr>

  <label>Nova casa</label>
  <input type="text" id="newHouseName" placeholder="Ex: Casa da Praia">
  <button onclick="criarCasa()">Adicionar Casa</button>
</div>


<div class="actions">
  <button class="btn-secondary">Cancelar</button>
  <button class="btn-primary" onclick="salvarConfiguracoes()">
    Salvar Configura√ß√µes
  </button>
</div>

<h2>-------------------------------</h2> 


<h1> üë• USU√ÅRIOS </h1>
<table id="usersTable">
  <thead>
    <tr>
      <th>Usu√°rio</th>
      <th>Perfil</th>
      <th>A√ß√£o</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>


<script>
/* ==========================
   CASAS
========================== */
async function carregarCasas() {
  const res = await fetch("/api/houses");
  const houses = await res.json();

  const select = document.getElementById("houseSelect");
  select.innerHTML = "";

  houses.forEach(h => {
    const opt = document.createElement("option");
    opt.value = h.id;
    opt.textContent = h.name;
    select.appendChild(opt);
  });
}

async function selecionarCasa() {
  const house_id = document.getElementById("houseSelect").value;

  await fetch("/api/houses/select", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({ house_id })
  });

  alert("Casa selecionada!");
}

async function criarCasa() {
  const name = document.getElementById("newHouseName").value;

  if (!name) {
    alert("Digite o nome da nova casa");
    return;
  }

  const res = await fetch("/api/houses", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({ name })
  });

  if (res.ok) {
    document.getElementById("newHouseName").value = "";
    carregarCasas();
    alert("Casa criada com sucesso!");
  } else {
    alert("Erro ao criar casa");
  }
}

/* ==========================
   USU√ÅRIOS
========================== */
async function carregarUsuarios() {
  const res = await fetch("/api/users");
  const users = await res.json();

  const tbody = document.querySelector("#usersTable tbody");
  tbody.innerHTML = "";

  users.forEach(u => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${u.username}</td>
      <td>${u.role}</td>
      <td>
        <button onclick="apagarUsuario(${u.id})">üóë Apagar</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

async function apagarUsuario(id) {
  if (!confirm("Tem certeza que deseja apagar este usu√°rio?")) return;

  const res = await fetch(`/api/users/${id}`, {
    method: "DELETE"
  });

  if (res.ok) {
    carregarUsuarios();
  } else {
    alert("Erro ao apagar usu√°rio");
  }
}

/* ==========================
   SALVAR CONFIGURA√á√ïES
========================== */
async function criarUsuario() {
  const username = document.getElementById("nome").value;
  const password = document.getElementById("senha").value;
  const role = document.getElementById("role").value;

  const res = await fetch("/api/users", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({username, password, role})
  });

  const data = await res.json();
  if (data.status === "ok") {
    alert("Usu√°rio criado!");
    carregarUsuarios();
  } else {
    alert(data.error || "Erro ao criar usu√°rio");
  }
}

/* ==========================
   INIT
========================== */
carregarCasas();
carregarUsuarios();
</script>

<script src="/static/settings.js"></script>

{% endblock %}
